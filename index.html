<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>EMI Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .fade-in { animation: fadeIn 0.7s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @media print { .no-print { display: none; } }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md fade-in">
    <h2 class="text-2xl font-bold text-center text-green-700 mb-4">ðŸ“Š EMI Calculator</h2>

    <div class="space-y-3">
      <input type="number" id="amount" placeholder="Loan Amount (â‚¹)" class="w-full p-2 border rounded-md" />
      <input type="number" id="rate" placeholder="Interest Rate (% per annum)" class="w-full p-2 border rounded-md" />
      <input type="number" id="term" placeholder="Loan Term (months)" class="w-full p-2 border rounded-md" />
      <input type="number" id="moratorium" placeholder="Moratorium Period (months, optional)" class="w-full p-2 border rounded-md" />
    </div>

    <button onclick="calculateEMI()" class="mt-4 bg-green-600 hover:bg-green-700 text-white w-full p-3 rounded-md text-lg font-semibold transition">Calculate</button>

    <div id="result" class="mt-6 space-y-2 fade-in hidden">
      <div><strong>Monthly EMI:</strong> â‚¹<span id="emi"></span></div>
      <div><strong>Total Interest:</strong> â‚¹<span id="interest"></span></div>
      <div><strong>Total Payment:</strong> â‚¹<span id="total"></span></div>
    </div>

    <canvas id="emiChart" class="my-4 hidden"></canvas>

    <div id="chartSection" class="mt-6 hidden fade-in">
      <h3 class="text-lg font-semibold mb-2">ðŸ“… EMI Payment Schedule</h3>
      <select id="yearFilter" class="mb-2 w-full p-2 border rounded-md"></select>
      <div class="overflow-x-auto max-h-64">
        <table class="min-w-full text-sm border" id="scheduleTable">
          <thead class="bg-gray-200 sticky top-0">
            <tr>
              <th class="border px-2 py-1">Month</th>
              <th class="border px-2 py-1">EMI</th>
              <th class="border px-2 py-1">Interest</th>
              <th class="border px-2 py-1">Principal</th>
              <th class="border px-2 py-1">Balance</th>
            </tr>
          </thead>
          <tbody class="bg-white" id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <button onclick="downloadPDF()" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-md font-semibold no-print transition">Download PDF</button>
  </div>

  <script>
    let schedule = [];

    function calculateEMI() {
      const principal = parseFloat(document.getElementById('amount').value);
      const rate = parseFloat(document.getElementById('rate').value);
      const term = parseInt(document.getElementById('term').value);
      let moratorium = parseInt(document.getElementById('moratorium').value);
      moratorium = isNaN(moratorium) ? 0 : moratorium;

      if (!principal || !rate || !term || moratorium > term) {
        alert("Please enter valid values.");
        return;
      }

      const monthlyRate = rate / 12 / 100;
      let balance = principal;
      let totalInterest = 0;
      let totalPayment = 0;

      schedule = [];

      // Moratorium period: interest accrues and is added to balance
      for (let i = 1; i <= moratorium; i++) {
        const interestOnly = balance * monthlyRate;
        balance += interestOnly;
        totalInterest += interestOnly;
        totalPayment += interestOnly;
        schedule.push([i, 0, interestOnly.toFixed(2), 0, balance.toFixed(2)]);
      }

      // EMI repayment
      const effectiveTerm = term - moratorium;
      const emi = (balance * monthlyRate * Math.pow(1 + monthlyRate, effectiveTerm)) / (Math.pow(1 + monthlyRate, effectiveTerm) - 1);

      for (let i = 1; i <= effectiveTerm; i++) {
        const interestPart = balance * monthlyRate;
        const principalPart = emi - interestPart;
        balance -= principalPart;
        if (balance < 0) balance = 0;
        totalInterest += interestPart;
        totalPayment += emi;
        schedule.push([i + moratorium, emi.toFixed(2), interestPart.toFixed(2), principalPart.toFixed(2), balance.toFixed(2)]);
      }

      document.getElementById('emi').innerText = emi.toFixed(2);
      document.getElementById('interest').innerText = totalInterest.toFixed(2);
      document.getElementById('total').innerText = totalPayment.toFixed(2);
      document.getElementById('result').classList.remove('hidden');
      document.getElementById('chartSection').classList.remove('hidden');
      buildScheduleTable();
      buildChart();
    }

    function buildScheduleTable() {
      const tbody = document.getElementById('tableBody');
      const yearFilter = document.getElementById('yearFilter');
      tbody.innerHTML = '';
      yearFilter.innerHTML = '<option value="all">All Years</option>';

      const years = new Set();
      schedule.forEach(row => years.add(Math.ceil(row[0]/12)));
      years.forEach(y => {
        const opt = document.createElement('option');
        opt.value = y;
        opt.text = `Year ${y}`;
        yearFilter.appendChild(opt);
      });

      yearFilter.onchange = function() {
        tbody.innerHTML = '';
        const selected = this.value;
        schedule.forEach(row => {
          if (selected === 'all' || Math.ceil(row[0]/12) == selected) {
            const tr = document.createElement('tr');
            row.forEach(cell => {
              const td = document.createElement('td');
              td.className = "border px-2 py-1 text-center";
              td.innerText = cell;
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          }
        });
      }

      yearFilter.dispatchEvent(new Event('change'));
    }

    function buildChart() {
      const ctx = document.getElementById('emiChart').getContext('2d');
      const totalInterest = parseFloat(document.getElementById('interest').innerText);
      const principal = parseFloat(document.getElementById('amount').value);
      document.getElementById('emiChart').classList.remove('hidden');
      if (window.chart) window.chart.destroy();
      window.chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Principal', 'Interest'],
          datasets: [{
            data: [principal, totalInterest],
            backgroundColor: ['#34d399', '#f87171']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(14);
      doc.text("EMI Calculator Report", 20, 20);
      doc.setFontSize(10);
      doc.text("Loan Amount: â‚¹" + document.getElementById('amount').value, 20, 30);
      doc.text("Interest Rate: " + document.getElementById('rate').value + "%", 20, 36);
      doc.text("Term: " + document.getElementById('term').value + " months", 20, 42);
      doc.text("Moratorium: " + (document.getElementById('moratorium').value || 0) + " months", 20, 48);
      doc.text("Monthly EMI: â‚¹" + document.getElementById('emi').innerText, 20, 54);
      doc.text("Total Interest: â‚¹" + document.getElementById('interest').innerText, 20, 60);
      doc.text("Total Payment: â‚¹" + document.getElementById('total').innerText, 20, 66);

      doc.autoTable({
        head: [['Month', 'EMI', 'Interest', 'Principal', 'Balance']],
        body: schedule.map(row => row.map(col => col.toString())),
        startY: 75,
        styles: { fontSize: 8 }
      });

      doc.save("emi-calculator.pdf");
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</body>
</html>
